-<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload CSV</title>
    <link rel="stylesheet" href="/static/css/compact.css">
</head>
<body>
    <h1>Upload CSV File</h1>
    <form id="uploadForm">
        <input id="fileInput" name="file" type="file" accept=".csv" required>
        <div>
            <label for="tagSelect">Existing Tags:</label>
            <select id="tagSelect" name="tags" multiple>
                {% for tag in tags %}
                    <option value="{{ tag.id }}">{{ tag.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="newTags">Add New Tags (comma separated):</label>
            <input type="text" id="newTags" name="new_tags" placeholder="e.g. Project, Extra Credit">
        </div>
        <input type="submit" value="Upload">
    </form>
    <div id="loadingMessage" style="display:none; margin-top:1rem; font-weight:bold;">
        Uploading... please wait.
    </div>
    <script>
        const form = document.getElementById('uploadForm');
        const loadingMessage = document.getElementById('loadingMessage');
        const fileInput = document.getElementById('fileInput');
        const tagSelect = document.getElementById('tagSelect');
        const newTagsInput = document.getElementById('newTags');

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            loadingMessage.style.display = 'block';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            // Existing tags
            const selectedTags = Array.from(tagSelect.selectedOptions).map(opt => opt.value);
            formData.append('tags', JSON.stringify(selectedTags));
            // New tags
            formData.append('new_tags', newTagsInput.value);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });
                if (!response.ok) throw new Error('Upload failed');
                window.location.href = '/dashboard';
            } catch (err) {
                loadingMessage.textContent = 'Upload failed. Please try again.';
            }
        });
    </script>
</body>
</html>
